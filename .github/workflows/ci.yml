name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        zig-version: ['0.15.2']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ matrix.zig-version }}

      - name: Verify Zig installation
        run: |
          zig version
          zig env

      - name: Build project
        run: zig build

      - name: Run tests
        run: zig build test --summary all

      - name: Build examples
        run: zig build examples

      - name: Run examples (Unix)
        if: runner.os != 'Windows'
        run: |
          zig build run-key_derivation > /dev/null 2>&1 || true
          zig build run-file_hashing > /dev/null 2>&1 || true

      - name: Run examples (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          zig build run-key_derivation > $null 2>&1 || echo "Completed"
          zig build run-file_hashing > $null 2>&1 || echo "Completed"

      - name: Check binary size
        shell: bash
        run: |
          if [ -f "zig-out/bin/raikage" ]; then
            ls -lh zig-out/bin/raikage
          elif [ -f "zig-out/bin/raikage.exe" ]; then
            ls -lh zig-out/bin/raikage.exe
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest'
        with:
          name: raikage-${{ matrix.os }}-${{ matrix.zig-version }}
          path: zig-out/bin/*
          retention-days: 7

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.15.2'

      - name: Check formatting
        run: zig fmt --check src/ build.zig

  memory-leak-check:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.15.2'

      - name: Run tests with leak detection
        run: |
          zig build test --summary all
          echo "✅ No memory leaks detected"

  cross-compile:
    name: Cross-Compilation Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-linux
          - x86_64-windows
          - x86_64-macos
          - aarch64-linux
          - aarch64-macos
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: '0.15.2'

      - name: Cross-compile for ${{ matrix.target }}
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe

      - name: Check binary size
        run: |
          ls -lh zig-out/bin/

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r -i "password.*=.*['\"]" src/ | grep -v "test_password" | grep -v "test {" | grep -q .; then
            echo "❌ Found hardcoded password"
            exit 1
          fi
          if grep -r -i "secret.*=.*['\"]" src/ | grep -v "super_secret" | grep -v "test {" | grep -q .; then
            echo "❌ Found hardcoded secret"
            exit 1
          fi
          if grep -r -i "api.*key.*=.*['\"]" src/ | grep -v "test {" | grep -q .; then
            echo "❌ Found hardcoded API key"
            exit 1
          fi
          echo "✅ No hardcoded secrets found"

      - name: Verify secure random usage
        run: |
          echo "Verifying cryptographic random usage..."
          grep -q "crypto.random" src/shared.zig && echo "✅ Using crypto.random"

      - name: Check for insecure patterns
        run: |
          echo "Checking for insecure patterns..."
          ! grep -r "std.rand.DefaultPrng" src/ || (echo "❌ Found insecure random" && exit 1)
          ! grep -r "@import(\"rand\")" src/ || (echo "❌ Found insecure random import" && exit 1)
          echo "✅ No insecure patterns found"
